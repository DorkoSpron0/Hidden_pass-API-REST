<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IPasswordAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hidden_pass</a> &gt; <a href="index.source.html" class="el_package">com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.adapters</a> &gt; <span class="el_source">IPasswordAdapter.java</span></div><h1>IPasswordAdapter.java</h1><pre class="source lang-java linenums">package com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.adapters;

import com.sena.hidden_pass.domain.models.PasswordModel;
import com.sena.hidden_pass.domain.usecases.PasswordUseCases;
import com.sena.hidden_pass.domain.usecases.UserUseCases;
import com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.DBO.FolderDBO;
import com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.DBO.PasswordDBO;
import com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.DBO.UserDBO;
import com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.IPasswordRepository;
import com.sena.hidden_pass.infrastructure.driven_adapters.mysqlJpa.IUserRepository;
import com.sena.hidden_pass.infrastructure.mappers.PasswordMapper;
import com.sena.hidden_pass.infrastructure.mappers.UserMapper;
import com.sena.hidden_pass.infrastructure.utils.AESUtil;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class IPasswordAdapter implements PasswordUseCases {

    private UserUseCases userAdapter;
    private IPasswordRepository passwordRepository;
    private IUserRepository userRepository;
    private AESUtil aesUtil;

<span class="fc" id="L29">    public IPasswordAdapter(AESUtil aesUtil, IPasswordRepository passwordRepository, UserUseCases userAdapter, IUserRepository userRepository) {</span>
<span class="fc" id="L30">        this.aesUtil = aesUtil;</span>
<span class="fc" id="L31">        this.passwordRepository = passwordRepository;</span>
<span class="fc" id="L32">        this.userAdapter = userAdapter;</span>
<span class="fc" id="L33">        this.userRepository = userRepository;</span>
<span class="fc" id="L34">    }</span>

    @Override
    public Set&lt;PasswordModel&gt; getAllPassword(UUID user_id) {
<span class="fc" id="L38">        UserDBO userFounded = UserMapper.userModelToDBO(userAdapter.getUserById(user_id));</span>
<span class="fc" id="L39">        return userFounded.getPasswordList().stream().map(</span>
                passwordDBO -&gt; {
                    try {
<span class="fc" id="L42">                        passwordDBO.setPassword(aesUtil.decrypt(passwordDBO.getPassword()));</span>
<span class="fc" id="L43">                    } catch (Exception e) {</span>
<span class="fc" id="L44">                        throw new RuntimeException(e);</span>
<span class="fc" id="L45">                    }</span>
<span class="fc" id="L46">                    return PasswordMapper.passwordDBOToModel(passwordDBO);</span>
                }
<span class="fc" id="L48">        ).collect(Collectors.toSet());</span>
    }

    @Override
    public PasswordModel getPasswordById(UUID password_id) {
<span class="fc" id="L53">        PasswordModel passwordFounded = PasswordMapper.passwordDBOToModel(passwordRepository.findById(password_id).orElseThrow(() -&gt; new IllegalArgumentException(&quot;Password not found&quot;)));</span>
        try{

<span class="fc" id="L56">            passwordFounded.setPassword(aesUtil.decrypt(passwordFounded.getPassword()));</span>
<span class="fc" id="L57">            return passwordFounded;</span>
<span class="fc" id="L58">        }catch (Exception ex){</span>
<span class="fc" id="L59">            throw new RuntimeException(ex);</span>
        }
    }

    @Override
    public PasswordModel createPassword(PasswordModel password, UUID user_id) {

<span class="fc" id="L66">        UserDBO userFounded = UserMapper.userModelToDBO(userAdapter.getUserById(user_id));</span>
        try{
            // Guardar la contraseña primero
<span class="fc" id="L69">            password.setPassword(aesUtil.encrypt(password.getPassword()));</span>
<span class="fc" id="L70">            PasswordDBO passwordSaved = passwordRepository.save(PasswordMapper.passwordModelToDBO(password));</span>

            // Obtener el usuario

            // Añadir la contraseña guardada (persistida) a la lista
<span class="fc" id="L75">            userFounded.getPasswordList().add(passwordSaved);  // Usar 'passwordSaved' en lugar de un nuevo objeto</span>

            // Guardar el usuario actualizado
<span class="fc" id="L78">            userRepository.save(userFounded);</span>

<span class="fc" id="L80">            return PasswordMapper.passwordDBOToModel(passwordSaved);</span>
<span class="fc" id="L81">        }catch (Exception ex){</span>
<span class="fc" id="L82">            throw new RuntimeException(ex);</span>
        }

    }

    @Override
    public PasswordModel editPassword(PasswordModel password, UUID password_id) {
<span class="fc" id="L89">        PasswordDBO passwordFounded = PasswordMapper.passwordModelToDBO(getPasswordById(password_id));</span>

<span class="fc" id="L91">        passwordFounded.setName(password.getName());</span>
        try{
<span class="fc" id="L93">            passwordFounded.setPassword(aesUtil.encrypt(password.getPassword()));</span>
<span class="fc" id="L94">        }catch (Exception ex){</span>
<span class="fc" id="L95">            throw new RuntimeException(ex);</span>
<span class="fc" id="L96">        }</span>
<span class="fc" id="L97">        passwordFounded.setEmail_user(password.getEmail_user());</span>
<span class="fc" id="L98">        passwordFounded.setUrl(password.getUrl());</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if(password.getId_folder() != null){</span>
<span class="fc" id="L100">            passwordFounded.setId_folder(new FolderDBO(</span>
<span class="fc" id="L101">                    password.getId_folder().getId_folder(),</span>
<span class="fc" id="L102">                    password.getId_folder().getName(),</span>
<span class="fc" id="L103">                    password.getId_folder().getIcon(),</span>
<span class="fc" id="L104">                    password.getId_folder().getDescription())</span>
            );
        }
<span class="fc" id="L107">        passwordFounded.setDescription(password.getDescription());</span>
<span class="fc" id="L108">        passwordFounded.setDateTime(LocalDateTime.now());</span>

<span class="fc" id="L110">        return PasswordMapper.passwordDBOToModel(passwordRepository.save(passwordFounded));</span>
    }

    @Override
    public String deletePassword(UUID password_id) {
<span class="fc" id="L115">        PasswordDBO passwordFounded = PasswordMapper.passwordModelToDBO(getPasswordById(password_id));</span>

<span class="fc" id="L117">        passwordRepository.delete(passwordFounded);</span>

<span class="fc" id="L119">        return &quot;Password with id &quot; + password_id + &quot; removed&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>